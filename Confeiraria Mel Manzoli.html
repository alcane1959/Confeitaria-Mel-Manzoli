<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mel Manzoli Confeitaria</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #fff5f8; color: #333; margin: 0; padding-bottom: 120px; }
        .header { text-align: center; padding: 20px 0; background: white; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; color: #c2185b; font-size: 26px; }
        .header p { margin: 0; color: #e91e63; font-weight: bold; font-size: 14px; }

        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 20px 0; border-top: 5px solid #e91e63; }
        
        .relatorio-topo { background: #fce4ec; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 2px solid #f8bbd0; }
        .relatorio-topo span { display: block; font-size: 14px; color: #c2185b; text-transform: uppercase; }
        .relatorio-topo strong { font-size: 32px; color: #c2185b; display: block; margin-top: 5px; }

        input, button, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        
        .fila-botoes { display: flex; gap: 8px; margin-top: 8px; align-items: center; }
        
        /* Bot√£o Gravar Venda - Fundo Branco e Borda Grossa */
        .btn-salvar { flex: 3; background: white; color: #e91e63; border: 3px solid #e91e63; font-weight: 900; font-size: 16px; margin: 0; cursor: pointer; height: 50px; border-radius: 8px; text-transform: uppercase; }
        
        /* Bot√£o Limpar Mini */
        .btn-limpar-mini { flex: 1.5; background: white; color: #c2185b; border: 2px solid #f8bbd0; font-size: 11px; margin: 0; padding: 5px; height: 50px; font-weight: bold; cursor: pointer; border-radius: 8px; }

        .linha-venda { border-bottom: 1px solid #eee; padding: 12px 0; }
        .cliente-nome { font-weight: bold; font-size: 18px; color: #333; }
        .valor-txt { font-weight: bold; color: #e91e63; font-size: 18px; float: right; }
        
        .badge-pago { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        .pago-sim { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .pago-nao { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }

        /* Bot√µes de A√ß√£o na Lista */
        .acoes { margin-top: 8px; display: flex; gap: 8px; }
        .btn-acao { flex: 1; padding: 8px; border-radius: 6px; background: white; font-size: 11px; font-weight: bold; cursor: pointer; border: 2px solid; text-transform: uppercase; }
        .btn-edit { color: #FF9800; border-color: #FF9800; }
        .btn-pedido { color: #25d366; border-color: #25d366; }
        .btn-del { color: #f44336; border-color: #f44336; }

        /* Barra Inferior */
        .barra-inferior { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top: 2px solid #eee; z-index: 1000; }
        .grade-botoes { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-rodape { background: white; padding: 8px; border-radius: 8px; font-weight: bold; font-size: 10px; cursor: pointer; text-transform: uppercase; height: 40px; margin: 0; border-width: 2px; border-style: solid; }
        .btn-backup { color: #2196F3; border-color: #2196F3; }
        .btn-restaurar { color: #607D8B; border-color: #607D8B; }
        .btn-clean-mes { color: #f44336; border-color: #f44336; grid-column: span 2; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üéÇ Mel Manzoli</h1>
        <p>CONFEITARIA</p>
    </div>

    <div class="card">
        <h3 id="titulo-form">üìù Novo Pedido</h3>
        <input type="hidden" id="edit-index" value="-1">
        <input type="date" id="data">
        <input type="text" id="cliente" placeholder="Nome do Cliente">
        <input type="text" id="produto" placeholder="Produto">
        <input type="number" id="valor" placeholder="Valor R$">
        <select id="status">
            <option value="nao">‚ùå N√£o Pago</option>
            <option value="sim">‚úÖ Pago</option>
        </select>
        
        <div class="fila-botoes">
            <button class="btn-salvar" id="btn-salvar" onclick="salvarPedido()">GRAVAR VENDA</button>
            <button class="btn-limpar-mini" onclick="limparCampos()">üßπ LIMPAR</button>
        </div>
        
        <button id="btn-cancelar" style="display:none; background:white; color:#999; border:2px solid #999; margin-top:8px; font-weight:bold; height:45px; border-radius:8px;" onclick="cancelarEdicao()">CANCELAR EDI√á√ÉO</button>
    </div>

    <div class="card">
        <h3>üìä Faturamento do M√™s (Pagos)</h3>
        <div class="relatorio-topo" id="faturamentoTotal">
            <span>Total Recebido</span>
            <strong>R$ 0,00</strong>
        </div>
        
        <h3>üõí Vendas Detalhadas</h3>
        <div id="listaVendas"></div>
    </div>

    <div class="barra-inferior">
        <div class="grade-botoes">
            <button class="btn-rodape btn-backup" onclick="exportarBackup()">üì• Backup (Salvar)</button>
            <button class="btn-rodape btn-restaurar" onclick="document.getElementById('importFile').click()">üìÇ Abrir Backup</button>
            <button class="btn-rodape btn-clean-mes" onclick="limparVendasMes()">‚ö†Ô∏è Limpar Tudo deste M√™s</button>
        </div>
        <input type="file" id="importFile" accept=".json" onchange="importarBackup(event)" style="display: none;">
    </div>

    <script>
        let pedidos = JSON.parse(localStorage.getItem('pedidos_mel_v6')) || [];
        document.getElementById('data').valueAsDate = new Date();

        function formatarDataBR(dataISO) {
            if(!dataISO) return "";
            const [ano, mes, dia] = dataISO.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function salvarPedido() {
            const d = document.getElementById('data').value;
            const c = document.getElementById('cliente').value.trim();
            const p = document.getElementById('produto').value.trim();
            const v = parseFloat(document.getElementById('valor').value);
            const s = document.getElementById('status').value;
            const index = parseInt(document.getElementById('edit-index').value);

            if (d && c && p && v) {
                const novoPedido = { data: d, cliente: c, produto: p, valor: v, pago: s };
                if (index === -1) { pedidos.push(novoPedido); } 
                else { pedidos[index] = novoPedido; cancelarEdicao(); }
                atualizarTudo();
                limparCampos();
            } else { alert("Preencha tudo!"); }
        }

        function atualizarTudo() {
            localStorage.setItem('pedidos_mel_v6', JSON.stringify(pedidos));
            renderizar();
        }

        function renderizar() {
            const listaDiv = document.getElementById('listaVendas');
            const fatDiv = document.getElementById('faturamentoTotal');
            let faturamentoM√™s = 0;
            const mesAtual = new Date().getMonth();
            const anoAtual = new Date().getFullYear();

            let html = '';
            for (let i = pedidos.length - 1; i >= 0; i--) {
                const p = pedidos[i];
                const dataPed = new Date(p.data + 'T00:00:00');
                if (dataPed.getMonth() === mesAtual && dataPed.getFullYear() === anoAtual) {
                    
                    // CIRURGIA AQUI: Soma apenas se o status for 'sim' (pago)
                    if (p.pago === 'sim') {
                        faturamentoM√™s += p.valor;
                    }

                    const statusClass = p.pago === 'sim' ? 'pago-sim' : 'pago-nao';
                    const statusTxt = p.pago === 'sim' ? 'PAGO' : 'PENDENTE';
                    
                    html += `
                    <div class="linha-venda">
                        <span class="cliente-nome">${p.cliente} <span class="badge-pago ${statusClass}">${statusTxt}</span></span>
                        <span class="valor-txt">R$ ${p.valor.toFixed(2)}</span>
                        <div class="prod-lista">${formatarDataBR(p.data)} - ${p.produto}</div>
                        <div class="acoes">
                            <button class="btn-acao btn-edit" onclick="prepararEdicao(${i})">‚úèÔ∏è Editar</button>
                            <button class="btn-acao btn-pedido" onclick="enviarPedido(${i})">üßæ Pedido</button>
                            <button class="btn-acao btn-del" onclick="excluirPedido(${i})">üóëÔ∏è Apagar</button>
                        </div>
                    </div>`;
                }
            }
            fatDiv.querySelector('strong').innerText = `R$ ${faturamentoM√™s.toFixed(2)}`;
            listaDiv.innerHTML = html || "<p style='text-align:center; color:#999;'>Sem vendas este m√™s.</p>";
        }

        function limparVendasMes() {
            if (confirm("Deseja apagar APENAS as vendas deste m√™s?")) {
                const mesAtual = new Date().getMonth();
                const anoAtual = new Date().getFullYear();
                pedidos = pedidos.filter(p => {
                    const dataPed = new Date(p.data + 'T00:00:00');
                    return dataPed.getMonth() !== mesAtual || dataPed.getFullYear() !== anoAtual;
                });
                atualizarTudo();
            }
        }

        function prepararEdicao(i) {
            const p = pedidos[i];
            document.getElementById('data').value = p.data;
            document.getElementById('cliente').value = p.cliente;
            document.getElementById('produto').value = p.produto;
            document.getElementById('valor').value = p.valor;
            document.getElementById('status').value = p.pago || 'nao';
            document.getElementById('edit-index').value = i;
            document.getElementById('btn-salvar').innerText = "ATUALIZAR";
            document.getElementById('titulo-form').innerText = "‚úèÔ∏è Editando Pedido";
            document.getElementById('btn-cancelar').style.display = "block";
            window.scrollTo(0,0);
        }

        function cancelarEdicao() {
            document.getElementById('edit-index').value = "-1";
            document.getElementById('btn-salvar').innerText = "GRAVAR VENDA";
            document.getElementById('titulo-form').innerText = "üìù Novo Pedido";
            document.getElementById('btn-cancelar').style.display = "none";
            limparCampos();
        }

        function excluirPedido(i) {
            if (confirm("Deseja apagar este pedido?")) {
                pedidos.splice(i, 1);
                atualizarTudo();
            }
        }

        function enviarPedido(i) {
            const p = pedidos[i];
            const msg = `*PEDIDO - MEL MANZOLI CONFEITARIA*\n\nOl√°, *${p.cliente}*!\nDetalhes do pedido:\n\nüìÖ Data: ${formatarDataBR(p.data)}\nüéÇ Produto: ${p.produto}\nüí∞ Valor: *R$ ${p.valor.toFixed(2)}*\nüí≥ PIX: 121.108.468-01\n\n\nObrigada! üë©üèª‚Äçüç≥`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`);
        }

        function limparCampos() {
            document.getElementById('cliente').value = "";
            document.getElementById('produto').value = "";
            document.getElementById('valor').value = "";
            document.getElementById('status').value = "nao";
            document.getElementById('data').valueAsDate = new Date();
            document.getElementById('edit-index').value = "-1";
        }

        function exportarBackup() {
            const agora = new Date();
            const blob = new Blob([JSON.stringify(pedidos)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `BACKUP_Mel_${agora.toLocaleDateString('pt-BR').replace(/\//g,'-')}_${agora.getHours()}h${agora.getMinutes()}.json`;
            a.click();
        }

        function importarBackup(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                pedidos = JSON.parse(ev.target.result);
                atualizarTudo();
                alert("Dados restaurados!");
            };
            if(e.target.files[0]) reader.readAsText(e.target.files[0]);
        }

        renderizar();
    </script>
</body>
</html>